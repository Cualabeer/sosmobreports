<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOS Customer Job Entry</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;}
.container{max-width:600px;margin:20px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
label{display:block;margin-top:10px;font-weight:bold;}
input, select{width:100%;padding:10px;margin-top:5px;border-radius:6px;border:1px solid #ccc;font-size:1em;}
button{width:100%;padding:12px;margin-top:15px;font-weight:bold;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;}
#map{height:250px;width:100%;margin-top:10px;border-radius:6px;}
#qrContainer{text-align:center;margin-top:20px;}
</style>
</head>
<body>

<div class="container">
<h2>SOS Job Entry</h2>

<label>Customer Name:</label>
<input type="text" id="customerName" placeholder="Full Name">

<label>Vehicle Registration:</label>
<input type="text" id="vehicleReg" placeholder="ABC123">

<label>Vehicle Make/Model:</label>
<input type="text" id="vehicleModel" placeholder="BMW 118i Sport">

<label>Job Description:</label>
<input type="text" id="jobDetails" placeholder="Oil leak, brake issue etc.">

<label>Location:</label>
<div id="map"></div>
<input type="text" id="addressInput" placeholder="Type your address">

<button id="locBtn">Use My Location</button>
<button id="generateQR">Generate QR Code</button>

<div id="qrContainer"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- QR Code JS -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
let map = L.map('map').setView([51.3782, 0.5075], 13);
let marker = L.marker([51.3782, 0.5075], {draggable:true}).addTo(map);

// OSM Tile Layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// Update lat/lng when marker is dragged
marker.on('dragend', function(e){
  let pos = marker.getLatLng();
  document.getElementById('lat').value = pos.lat;
  document.getElementById('lng').value = pos.lng;
});

// Hidden fields for lat/lng
let latInput = document.createElement('input'); latInput.type='hidden'; latInput.id='lat';
let lngInput = document.createElement('input'); lngInput.type='hidden'; lngInput.id='lng';
document.querySelector('.container').appendChild(latInput);
document.querySelector('.container').appendChild(lngInput);

// Use GPS Location
document.getElementById('locBtn').addEventListener('click', ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos)=>{
      let lat = pos.coords.latitude;
      let lng = pos.coords.longitude;
      marker.setLatLng([lat,lng]);
      map.setView([lat,lng],16);
      latInput.value = lat;
      lngInput.value = lng;
      document.getElementById('addressInput').value = "Detected location"; // placeholder, optional reverse geocode
    }, ()=>{
      alert("Unable to get GPS location. Please enter manually.");
    });
  } else alert("Geolocation not supported");
});

// Address autocomplete using Photon API (free OSM service)
let addressInput = document.getElementById('addressInput');
addressInput.addEventListener('input', async ()=>{
  let val = addressInput.value;
  if(val.length < 3) return;
  let res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(val)}&limit=5`);
  let data = await res.json();
  // Show suggestions (simple, console log for now)
  console.log("Suggestions:", data.features.map(f=>f.properties.name + ", " + f.properties.city));
  if(data.features.length>0){
    let f = data.features[0];
    let lat = f.geometry.coordinates[1];
    let lng = f.geometry.coordinates[0];
    marker.setLatLng([lat,lng]);
    map.setView([lat,lng],16);
    latInput.value = lat;
    lngInput.value = lng;
    addressInput.value = f.properties.name + (f.properties.city ? ", " + f.properties.city : "");
  }
});

// Generate QR Code
document.getElementById('generateQR').addEventListener('click', ()=>{
  let payload = {
    customerName: document.getElementById('customerName').value,
    vehicleReg: document.getElementById('vehicleReg').value,
    vehicleModel: document.getElementById('vehicleModel').value,
    jobDetails: document.getElementById('jobDetails').value,
    location: {
      latitude: latInput.value,
      longitude: lngInput.value,
      address: document.getElementById('addressInput').value
    },
    pin: Math.floor(1000 + Math.random()*9000) // 4-digit PIN
  };
  QRCode.toCanvas(payload.pin ? payload.pin : "0000", {width:200}, function(err,canvas){
    if(err)console.error(err);
    let container = document.getElementById('qrContainer');
    container.innerHTML="";
    container.appendChild(canvas);
    // Add JSON hidden text for scanning
    let pre = document.createElement('pre'); pre.textContent = JSON.stringify(payload, null, 2);
    container.appendChild(pre);
  });
});
</script>

</body>
</html>