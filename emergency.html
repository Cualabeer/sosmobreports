<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emergency Call-Out</title>
<style>
  /* Full-screen emergency modal */
  body {
    margin: 0;
    font-family: sans-serif;
    background: #111;
    color: #fff;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  body.emergency-active > *:not(#emergency-modal) {
    filter: blur(8px);
    pointer-events: none;
  }

  #emergency-modal {
    position: fixed;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(8px);
    z-index: 9999;
  }

  .emergency-card {
    width: 100%;
    max-width: 420px;
    background: #222;
    padding: 24px;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .emergency-card h2 {
    margin: 0 0 8px;
    font-size: 1.5em;
    text-align: center;
  }

  input, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 1em;
  }

  textarea {
    resize: none;
    height: 80px;
  }

  button {
    width: 100%;
    padding: 14px;
    font-size: 1.1em;
    border-radius: 8px;
    border: none;
    background: #ff3b30;
    color: #fff;
    cursor: pointer;
  }

  button.secondary {
    background: #444;
    margin-top: 8px;
  }
</style>
</head>
<body>

<!-- Background page content -->
<div id="content">
  <h1>SOS Mechanics</h1>
  <p>Tap Emergency if you need immediate assistance.</p>
  <button onclick="openEmergency()">ðŸš¨ Emergency Breakdown</button>
</div>

<!-- Emergency Modal -->
<div id="emergency-modal" class="hidden">
  <div class="emergency-card">
    <h2>ðŸš¨ Emergency Breakdown</h2>
    <p style="font-size:0.9em; text-align:center;">Fast help. Only essential details required.</p>

    <input type="text" id="vehicleReg" placeholder="Vehicle Registration (AB12 CDE)" required>
    <input type="text" id="locationText" placeholder="Your Location (e.g., Tesco Extra, Snodland)">
    <button type="button" onclick="useMyLocation()">Use my location</button>
    <textarea id="issue" placeholder="Whatâ€™s wrong? (e.g., Car wonâ€™t start)"></textarea>
    <input type="tel" id="phone" placeholder="Mobile Number" required>

    <button onclick="generateEmergencyQR()">Generate QR & Open WhatsApp</button>
    <button class="secondary" onclick="closeEmergency()">Cancel</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
function openEmergency() {
  document.body.classList.add('emergency-active');
  document.getElementById('emergency-modal').classList.remove('hidden');
}

function closeEmergency() {
  document.body.classList.remove('emergency-active');
  document.getElementById('emergency-modal').classList.add('hidden');
}

// Attempt browser GPS
function useMyLocation() {
  if (!navigator.geolocation) {
    alert('Geolocation not supported.');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    document.getElementById('locationText').value = `Lat:${lat}, Lng:${lng}`;
  }, err => {
    alert('Unable to get location.');
  });
}

// Generate QR and open WhatsApp
function generateEmergencyQR() {
  const reg = document.getElementById('vehicleReg').value.trim().toUpperCase();
  const loc = document.getElementById('locationText').value.trim();
  const issue = document.getElementById('issue').value.trim();
  const phone = document.getElementById('phone').value.trim();

  if (!reg || !loc || !issue || !phone) {
    alert('Please fill all required fields.');
    return;
  }

  const timestamp = Date.now();
  const jobId = `SOS-EMG-${reg.replace(/\s+/g,'')}-${timestamp}`;

  // Job object (can be saved serverless in JSON)
  const job = {
    job_id: jobId,
    type: 'emergency',
    status: 'awaiting_mechanic',
    vehicle: { reg },
    customer: { phone },
    location: { text: loc },
    issue: issue,
    timestamps: { created: timestamp }
  };

  // Generate QR
  const qrData = JSON.stringify({ job_id: jobId, type: 'emergency', v: 1 });
  QRCode.toDataURL(qrData).then(url => {
    // Auto-download QR
    const a = document.createElement('a');
    a.href = url;
    a.download = `${jobId}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Open WhatsApp
    const msg = encodeURIComponent(
      `ðŸš¨ Emergency Breakdown\nReg: ${reg}\nLocation: ${loc}\nIssue: ${issue}\nTime: ${new Date(timestamp).toLocaleString()}\n\nQR attached.`
    );
    window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${msg}`, '_blank');

    alert('QR generated and WhatsApp opened.');
    closeEmergency();
  });
}
</script>
</body>
</html>