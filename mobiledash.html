<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mechanic Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<style>
body, html {margin:0;padding:0;font-family:sans-serif;background:#121212;color:#fff;}
header {position:fixed;top:0;left:0;width:100%;background:#1a1a1a;padding:10px;z-index:100;}
#ticker {white-space:nowrap;overflow:hidden;}
#ticker span {display:inline-block;padding-right:50px;animation:scroll 20s linear infinite;}
@keyframes scroll {0%{transform:translateX(100%);}100%{transform:translateX(-100%);}}
footer {position:fixed;bottom:0;left:0;width:100%;background:#1a1a1a;padding:10px;display:flex;justify-content:space-around;z-index:100;}
.job-container {margin-top:60px;margin-bottom:60px;display:flex;overflow-x:auto;padding:10px;gap:10px;}
.job-card {min-width:250px;background:#222;padding:15px;border-radius:10px;flex-shrink:0;position:relative;}
.start-job-btn, .pdf-btn {margin-top:10px;padding:10px;width:100%;border:none;border-radius:5px;color:#fff;background:#4caf50;cursor:pointer;}
.start-job-btn:hover, .pdf-btn:hover {background:#45a049;}
#map {height:200px;width:100%;margin:10px 0;border-radius:10px;}
#qrScanner {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:300;}
#qrScanner video {width:100%;height:100%;object-fit:cover;}
#closeQR {position:absolute;top:10px;right:10px;padding:10px;}
#checksModal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);overflow-y:auto;z-index:400;padding:20px;}
.check-item {padding:10px;border-bottom:1px solid #444;}
button.close-modal {position:absolute;top:10px;right:10px;padding:10px;background:#f44336;border:none;color:#fff;border-radius:5px;}
</style>
</head>
<body>

<header>
<div id="ticker"><span>ðŸš¨ New Jobs Coming In - Emergency: AB12CDE - Standard: XY34ZK - Same Day: MN56OP</span></div>
</header>

<div class="job-container" id="jobContainer">
<!-- Job cards will appear here -->
</div>

<div id="map"></div>

<footer>
<button id="openQR">Scan QR</button>
<button id="refreshJobs">Refresh</button>
</footer>

<!-- QR Scanner Overlay -->
<div id="qrScanner">
  <video id="qrVideo"></video>
  <button id="closeQR">Close</button>
</div>

<!-- Essential Checks Modal -->
<div id="checksModal">
  <button class="close-modal">Close</button>
  <h2>Essential Checks</h2>
  <div class="check-item"><input type="checkbox"> Engine Oil Level</div>
  <div class="check-item"><input type="checkbox"> Coolant Level</div>
  <div class="check-item"><input type="checkbox"> Battery Condition</div>
  <div class="check-item"><input type="checkbox"> Brake Fluid</div>
  <div class="check-item"><input type="checkbox"> Tire Pressure</div>
  <div class="check-item"><input type="checkbox"> Lights & Indicators</div>
  <div class="check-item"><input type="checkbox"> Wipers</div>
  <div class="check-item"><input type="checkbox"> Belts & Hoses</div>
  <div class="check-item"><input type="checkbox"> Fuel Level</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
// --- Map Setup ---
const map = L.map('map').setView([51.332593, 0.549980], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);
let jobMarker;

// --- Job Container ---
const jobContainer = document.getElementById('jobContainer');

// --- Sample Jobs ---
const sampleJobs = [
  {"reg":"AB12CDE","location":"51.332593,0.549980","priority":"Emergency","customer":"John Smith","issue":"Won't start"},
  {"reg":"XY34ZK","location":"51.335000,0.550500","priority":"Same Day","customer":"Alice Jones","issue":"Flat Tire"},
  {"reg":"MN56OP","location":"51.330000,0.548000","priority":"Standard","customer":"Bob Lee","issue":"Battery low"},
  {"reg":"CD78FG","location":"51.336000,0.552000","priority":"Standard","customer":"Carol","issue":"Brake squeak"},
  {"reg":"HI90JK","location":"51.338000,0.553000","priority":"Emergency","customer":"Dan","issue":"Overheating"},
  {"reg":"LM12NO","location":"51.340000,0.554000","priority":"Same Day","customer":"Eva","issue":"Engine light"},
  {"reg":"PQ34RS","location":"51.342000,0.555000","priority":"Standard","customer":"Frank","issue":"Stalling"}
];

// --- Display Jobs ---
function renderJobs(jobs){
  jobContainer.innerHTML='';
  // Sort Emergency first
  jobs.sort((a,b)=>{
    const prio = {"Emergency":1,"Same Day":2,"Standard":3};
    return prio[a.priority]-prio[b.priority];
  });
  jobs.forEach(job=>{
    const card = document.createElement('div');
    card.className='job-card';
    card.dataset.reg=job.reg;
    card.dataset.location=job.location;
    card.dataset.priority=job.priority;
    card.innerHTML=`<h3>${job.reg} - ${job.priority}</h3>
                    <p>Customer: ${job.customer}</p>
                    <p>Issue: ${job.issue}</p>
                    <button class="start-job-btn">Start Job</button>
                    <button class="pdf-btn">Generate PDF</button>`;
    jobContainer.appendChild(card);

    // Start job button
    card.querySelector('.start-job-btn').onclick = ()=>{
      document.getElementById('checksModal').style.display='block';
      const [lat,lng]=job.location.split(',');
      if(jobMarker) map.removeLayer(jobMarker);
      jobMarker=L.marker([lat,lng]).addTo(map);
      map.setView([lat,lng],14);
    };

    // PDF button
    card.querySelector('.pdf-btn').onclick = ()=>generatePDF(card);
  });
}

// --- Generate PDF ---
function generatePDF(jobCard){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g,'-');
    doc.setFontSize(16);
    doc.text(`Job Report - ${jobCard.dataset.reg}`,10,10);
    doc.setFontSize(12);
    doc.text(jobCard.querySelector('p:nth-child(2)').textContent,10,20);
    doc.text(jobCard.querySelector('p:nth-child(3)').textContent,10,30);
    doc.text(`Location: ${jobCard.dataset.location}`,10,40);
    doc.save(`${jobCard.dataset.reg}_${timestamp}.pdf`);
}

// --- Initial Render ---
renderJobs(sampleJobs);

// --- QR Scanner ---
const qrScanner = document.getElementById('qrScanner');
const qrVideo = document.getElementById('qrVideo');
let qrStream;

document.getElementById('openQR').onclick=async()=>{
  qrScanner.style.display='block';
  qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
  qrVideo.srcObject = qrStream;
  qrVideo.play();
  scanQRCode();
};

document.getElementById('closeQR').onclick=()=>{
  qrScanner.style.display='none';
  qrVideo.pause();
  if(qrStream) qrStream.getTracks().forEach(track=>track.stop());
};

async function scanQRCode(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const code = async ()=>{
        if(qrVideo.readyState===qrVideo.HAVE_ENOUGH_DATA){
            canvas.width=qrVideo.videoWidth;
            canvas.height=qrVideo.videoHeight;
            ctx.drawImage(qrVideo,0,0);
            const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const qr = jsQR(imageData.data,canvas.width,canvas.height);
            if(qr){
                handleJobQR(qr.data);
                qrScanner.style.display='none';
                qrVideo.pause();
                if(qrStream) qrStream.getTracks().forEach(track=>track.stop());
                return;
            }
        }
        requestAnimationFrame(code);
    };
    requestAnimationFrame(code);
}

function handleJobQR(qrData){
    try{
        const job=JSON.parse(qrData);
        sampleJobs.unshift(job);
        renderJobs(sampleJobs);
        alert(`New job loaded: ${job.reg}`);
    }catch(e){alert('Invalid QR code');}
}

// --- Close Modal ---
document.querySelector('#checksModal .close-modal').onclick=()=>document.getElementById('checksModal').style.display='none';

</script>
</body>
</html>